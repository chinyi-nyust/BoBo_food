<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>AAFCO è²“ä¸»é£Ÿç½ æª¢æ ¸ + æ¯æ—¥é¤µé£Ÿåˆ¤å®šï¼ˆåˆä½µ 14 ç¯„ä¾‹ / å„²å­˜ / æ­¸é›¶ï¼‰</title>
  <style>
    body { font-family: sans-serif; margin: 2em; background: #fefefe; }
    table { border-collapse: collapse; width: 100%; margin-top: 1em; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    th { background: #f2f2f2; }
    input { width: 5.6em; }
    .pass { background: #d4edda; }
    .fail { background: #f8d7da; }
    .controls { margin-top: 1em; display:flex; flex-wrap: wrap; gap:8px; align-items:center; }
    .muted { color: #888; font-size: 0.9em; margin-left: 0.5em; }
    .note  { font-size: 0.9em; color: #555; margin-top: 0.5em; line-height: 1.4; }
    .pill  { padding:2px 8px; border-radius:999px; border:1px solid #ccc; }
    .hide  { display:none; }
    td.reason { text-align:left; font-size:.9em; }
    #dailyBox { border:1px solid #ccc; padding:12px; border-radius:8px; margin-top:16px; background:#fafafa; }
    #judgeText.pass { color:#0a7a32; font-weight:700; }
    #judgeText.warn { color:#b36b00; font-weight:700; }
    #judgeText.fail { color:#a40000; font-weight:700; }
    .wide { min-width: 12em; }
  </style>
</head>
<body>
  <h2>AAFCO è²“ä¸»é£Ÿç½ ä¹¾ç‰©æ¯”èˆ‡æ¯å¤©ç†±é‡æª¢æ ¸ï¼ˆåˆä½µ 13 ç¯„ä¾‹ï½œåœ–ç‰‡ OCRï½œå¯å„²å­˜ï¼‰</h2>

  <div class="controls">
    <button onclick="addRow()">â• æ–°å¢ä¸€åˆ—</button>
    <button onclick="loadExamplesAll()">ğŸ“¥ è¼‰å…¥å…¨éƒ¨ 13 æ¬¾ç¯„ä¾‹</button>
    <button onclick="downloadCSV()">â¬‡ï¸ ä¸‹è¼‰ CSV</button>
    <button onclick="clearTable()">ğŸ—‘ï¸ æ¸…ç©ºè¡¨æ ¼</button>
    <span class="muted">è¼¸å…¥ as-fedï¼ˆåŒ…è£ï¼‰æ•¸å€¼ï¼Œç³»çµ±è‡ªå‹•ç®— DMã€ç£·/100kcalã€ml/åŒ…ã€kcal/åŒ…ï¼›å¯å„²å­˜/è¼‰å…¥è¡¨æ ¼ï¼Œä¸ç”¨é‡æ‰“ã€‚</span>
    <br style="flex-basis:100%">
    <button onclick="saveTable()">ğŸ’¾ å„²å­˜è¡¨æ ¼è³‡æ–™</button>
    <button onclick="loadTable()">ğŸ“‚ è¼‰å…¥å·²å„²å­˜</button>
    <button onclick="clearSaved()">ğŸ—‘ï¸ æ¸…é™¤å·²å„²å­˜</button>
    <button onclick="resetQty()">ğŸ§» æ¯å¤©åŒ…æ•¸æ­¸é›¶</button>
  </div>

  <div class="controls">
    <input type="file" id="imgInput" accept="image/*">
    <button id="ocrToRow">ğŸ§  åœ–ç‰‡ OCR â†’ æ–°å¢ä¸€åˆ—</button>
    <span id="ocrStatus" class="muted"></span>
    <button id="pasteText">è²¼ä¸Š OCR æ–‡å­— â†’ æ–°å¢ä¸€åˆ—</button>
  </div>

  <!-- æª¢æ ¸æ¨¡å¼åˆ‡æ› -->
  <div class="controls">
    <label>æª¢æ ¸æ¨¡å¼ï¼š
      <select id="mode">
        <option value="aafco" selected>AAFCOï¼ˆDMï¼šç¶­æŒâ‰¥è›‹ç™½26/è„‚è‚ª9ï¼‰</option>
        <option value="literature">æ–‡ç»å»ºè­°ï¼ˆè›‹ç™½ 30â€“45% DMã€è„‚è‚ªâ‰¥25% DMï¼‰</option>
        <option value="both">å…©è€…éƒ½è¦ï¼ˆåŒæ™‚ç¬¦åˆï¼‰</option>
      </select>
    </label>
    <span class="muted">åˆ‡æ›å¾Œè¡¨æ ¼åªé¡¯ç¤ºç›¸é—œæ¬„ä½ï¼Œä¸¦åœ¨å³å´æç¤ºé€šé/åä½/åé«˜ã€‚</span>
  </div>

  <!-- ä¸»è¡¨ -->
  <table id="dataTable">
    <thead>
      <tr>
        <th class="wide">å“ç‰Œ/å£å‘³</th>
        <th>è›‹ç™½%<br>(as-fed)</th>
        <th>è„‚è‚ª%</th>
        <th>çº–ç¶­%</th>
        <th>ç°åˆ†%</th>
        <th>ç¢³æ°´%</th>
        <th>æ°´åˆ†%</th>
        <th>kcal/kg</th>
        <th>ç£·% (as-fed)</th>
        <th>æ°´åˆ† ml/100g</th>
        <th>æ¯åŒ…æ·¨é‡ (g)</th>
        <th>æ°´åˆ† ml/åŒ…</th>
        <th>kcal/g</th>
        <th>kcal/åŒ…</th>
        <th class="col-aafco">è›‹ç™½(DM)</th>
        <th class="col-aafco">è„‚è‚ª(DM)</th>
        <th>è›‹ç™½(DM)</th>
        <th>è„‚è‚ª(DM)</th>
        <th>ç£·/100kcal (mg)</th>
        <th>ä½ç£·â‰¤250</th>
        <th class="col-aafco">AAFCO ç¶­æŒ</th>
        <th class="col-lit">æ–‡ç»æª¢æ ¸</th>
        <th class="col-both">åŒæ™‚ç¬¦åˆ</th>
        <th>æ¯å¤©åŒ…æ•¸</th>
        <th>kcal/æ—¥ï¼ˆæ­¤å£å‘³ï¼‰</th>
        <th class="reason">æç¤ºï¼ˆé€šé/åä½/åé«˜ï¼‰</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- æ¯æ—¥é¤µé£Ÿåˆ¤å®š -->
  <div id="dailyBox">
    <strong>ğŸ“¦ æ¯æ—¥é¤µé£Ÿåˆ¤å®šï¼ˆä»¥ DER åƒè€ƒè¡¨ç‚ºä¸»ï¼‰</strong><br>
    <div class="controls" style="margin:8px 0;">
      <label>é«”é‡(kg)ï¼š<input id="bw" type="number" step="0.1" value="5"></label>
      <label>DER ä¾†æºï¼š
        <select id="derSource">
          <option value="table" selected>åƒè€ƒè¡¨ï¼ˆ0.5kg åˆ»åº¦ï¼‰</option>
          <option value="formula">å…¬å¼ï¼ˆé€£çºŒï¼‰</option>
        </select>
      </label>
      <label>DER å€æ•¸ï¼š
        <select id="derFactor">
          <option value="0.8">0.8 è‚¥èƒ–/æ¸›é‡</option>
          <option value="1.0">1.0 ä¹…åæˆè²“</option>
          <option value="1.1">1.1 ä¸­å¹´/è€è²“</option>
          <option value="1.2" selected>1.2 å·²çµç´®æˆè²“</option>
          <option value="1.4">1.4 æœªçµç´®æˆè²“</option>
        </select>
      </label>
      <label>å…è¨±èª¤å·® Â±%ï¼š<input id="tol" type="number" step="1" value="10"></label>
      <button id="recalcDaily">é‡æ–°åˆ¤å®š</button>
    </div>
    <div>
      åˆè¨ˆç†±é‡ <strong id="sumKcal">0</strong> kcal/æ—¥ã€€|ã€€è¡¨æ ¼ç›®æ¨™ <strong id="targetKcal">0</strong> kcal/æ—¥ã€€|ã€€
      <span id="judgeText" class="pill">å°šæœªè¨ˆç®—</span>
    </div>
    <div class="note">è¡¨æ ¼å€¼ä»¥ 0.5 kg ç‚ºåˆ»åº¦ï¼Œæœƒå°‡é«”é‡å››æ¨äº”å…¥åˆ°æœ€æ¥è¿‘ 0.5 kgï¼Œä¸¦ç”¨ RER=70Ã—W^0.75 Ã— å€æ•¸è¨ˆå¾—ã€‚åˆ¤å®šï¼šåœ¨ç›®æ¨™ Â± å…è¨±èª¤å·®% å…§ï¼ã€Œé”æ¨™ã€ï¼Œå°æ–¼ï¼ã€Œåä½ã€ï¼Œå¤§æ–¼ï¼ã€Œåé«˜ã€ã€‚</div>
  </div>

  <div class="note">
    ğŸ“ <strong>æ¨™æº–èˆ‡ç¯„åœ</strong><br>
    â€§ AAFCOï¼ˆDMï¼Œç¶­æŒï¼‰ï¼šè›‹ç™½â‰¥26%ã€è„‚è‚ªâ‰¥9%ã€‚<br>
    â€§ æ–‡ç»å»ºè­°ï¼šè›‹ç™½ 30â€“45% DMã€è„‚è‚ªâ‰¥25% DMã€‚<br>
    â€§ ä½ç£·åƒè€ƒï¼šâ‰¤250 mg/100kcalï¼ˆè…è²“å¯è€ƒæ…® â‰¤200ï¼‰ã€‚<br>
    â€§ æ°´åˆ† ml/100g ï¼ æ°´åˆ†%ï¼ˆæ°´å¯†åº¦â‰ˆ1 g/mlï¼‰ï¼›æ°´åˆ† ml/åŒ… ï¼ æ°´åˆ†% Ã— åŒ…è£é‡é‡(g) Ã· 100ï¼›kcal/g ï¼ kcal/kg Ã· 1000ï¼›kcal/åŒ… ï¼ kcal/g Ã— åŒ…è£é‡é‡(g)ã€‚
  </div>

  <script>
    const LS_KEY = 'AAFCO_DM_TABLE_ALL14';

    function fmt(n, d=1){ return (n==null || isNaN(n))? '' : (+n).toFixed(d); }
    function num(val){ const n = parseFloat(val); return isNaN(n)? null : n; }

    function modeNow(){ return document.getElementById('mode').value; }
    function applyMode(){
      const m = modeNow();
      document.querySelectorAll('.col-aafco').forEach(el=> el.classList.toggle('hide', !(m==='aafco'||m==='both')));
      document.querySelectorAll('.col-lit').forEach(el=> el.classList.toggle('hide', !(m==='literature'||m==='both')));
      document.querySelectorAll('.col-both').forEach(el=> el.classList.toggle('hide', !(m==='both')));
    }
    document.getElementById('mode').addEventListener('change', ()=> {
      document.querySelectorAll('#dataTable tbody tr').forEach(tr=> calc(tr));
    });

    function literatureJudge(pDM, fDM){
      if(pDM==null || fDM==null) return {pass:false, reason:'ç¼ºå°‘æ•¸å€¼'};
      if(pDM < 30) return {pass:false, reason:'è›‹ç™½åä½ (<30% DM)'};
      if(pDM > 45) return {pass:false, reason:'è›‹ç™½åé«˜ (>45% DM)'};
      if(fDM < 25) return {pass:false, reason:'è„‚è‚ªåä½ (<25% DM)'};
      return {pass:true, reason:'é€šé'};
    }
    function aafcoReason(pDM,fDM){
      const lacks = [];
      if(pDM==null || fDM==null) return 'ç¼ºå°‘æ•¸å€¼';
      if(pDM<26) lacks.push('è›‹ç™½<26%');
      if(fDM<9)  lacks.push('è„‚è‚ª<9%');
      return lacks.join('ã€');
    }

    function calc(tr){
      const qs = sel => tr.querySelector(sel);
      const get = cls => num(qs('input.'+cls)?.value);
      const set = (cls, v, d=1) => { const td = qs('td.'+cls); if(td) td.textContent = fmt(v,d); };
      const mark = (cls, ok) => { const td = qs('td.'+cls); if(!td) return; td.textContent = ok? 'âœ… åˆæ ¼':'âŒ ä¸åˆæ ¼'; td.className = cls + ' ' + (ok? 'pass':'fail'); };

      const p = get('protein'), f = get('fat'), fi = get('fiber'), ash = get('ash'), mo = get('moisture'), me = get('me'), pphos = get('p'), pkg = get('pkg'), qty = get('qty');
      let carb = get('carb');
      if(carb==null && [p,f,fi,ash,mo].every(v=>v!=null)){ const s=p+f+fi+ash+mo; carb = (100-s); if(carb<0) carb=null; if(qs('input.carb') && carb!=null) qs('input.carb').value = fmt(carb,1); }

      const dm = (mo!=null)? (100-mo) : null;
      const pDM = (dm && p!=null)? p/dm*100 : null;
      const fDM = (dm && f!=null)? f/dm*100 : null;

      const kcal100g = (me!=null)? me/10 : null;
      const kcalPerG  = (me!=null)? me/1000 : null;

      const p1000 = (kcal100g && p!=null)? (p*1000)/kcal100g : null;
      const f1000 = (kcal100g && f!=null)? (f*1000)/kcal100g : null;

      const waterMl100 = (mo!=null)? mo : null;
      const waterPkg   = (mo!=null && pkg!=null)? mo/100 * pkg : null;
      const kcalPkg    = (kcalPerG!=null && pkg!=null)? kcalPerG * pkg : null;
      const kcalDay    = (kcalPkg!=null && qty!=null)? kcalPkg * qty : null;

      const pMg100 = (pphos!=null && kcal100g)? (100000*pphos)/kcal100g : null;

      const okAafco = (pDM!=null && fDM!=null && pDM>=26 && fDM>=9);
      const lit = literatureJudge(pDM, fDM);
      const okBoth = okAafco && lit.pass;

      set('proteinDM', pDM);
      set('fatDM', fDM);
      set('p1000', p1000);
      set('f1000', f1000);
      set('waterml', waterMl100);
      set('waterpkg', waterPkg, 1);
      set('kcalg', kcalPerG, 2);
      set('kcalpkg', kcalPkg, 0);
      set('kcalday', kcalDay, 0);
      set('pmg100', pMg100, 0);

      mark('lowp', (pMg100!=null)? (pMg100<=250) : null);
      mark('aafco', okAafco);
      mark('lit', lit.pass);
      mark('both', okBoth);

      const r = qs('td.reason'); if(r){ r.textContent = (modeNow()==='aafco')
          ? (okAafco? 'é€šé' : aafcoReason(pDM,fDM))
          : (modeNow()==='literature'
              ? (lit.pass? 'é€šé' : lit.reason)
              : (okBoth? 'é€šé' : (!okAafco? 'AAFCOæœªé”ï¼š'+aafcoReason(pDM,fDM) : 'æ–‡ç»æœªé”ï¼š'+lit.reason))
            );
      }
      updateDailySummary();
      applyMode();
    }

    function rer(w){ return 70 * Math.pow(w, 0.75); }
    function tableDER(weight, factor){
      const src = document.getElementById('derSource').value;
      let w = weight;
      if(src==='table'){ w = Math.round(weight*2)/2; }
      return rer(w) * factor;
    }

    function updateDailySummary(){
      const rows = document.querySelectorAll('#dataTable tbody tr');
      let sum = 0;
      rows.forEach(tr=>{
        const pkg = num(tr.querySelector('input.pkg')?.value);
        const me = num(tr.querySelector('input.me')?.value);
        const qty = num(tr.querySelector('input.qty')?.value);
        if(pkg!=null && me!=null && qty!=null){
          const kcalg = me/1000;
          const kcalpkg = kcalg*pkg;
          sum += kcalpkg * qty;
        }
      });
      const bw = parseFloat(document.getElementById('bw').value||'5');
      const factor = parseFloat(document.getElementById('derFactor').value||'1.2');
      const target = tableDER(bw, factor);
      document.getElementById('sumKcal').textContent = Math.round(sum);
      document.getElementById('targetKcal').textContent = Math.round(target);
      const tol = parseFloat(document.getElementById('tol').value||'10');
      const judge = document.getElementById('judgeText');
      if(!sum || !target){ judge.textContent='å°šæœªè¨ˆç®—'; judge.className='pill'; return; }
      const diffPct = (sum-target)/target*100;
      const adiff = Math.abs(diffPct);
      let label='é”æ¨™', cls='pass';
      if(adiff>tol){ label = (sum>target)? 'åé«˜' : 'åä½'; cls='fail'; }
      else if(adiff>tol/2){ cls='warn'; label = (sum>target)? 'ç•¥é«˜' : 'ç•¥ä½'; }
      judge.textContent = `${label}ï¼ˆå·®è· ${diffPct.toFixed(1)}%ï¼‰`;
      judge.className = `pill ${cls}`;
    }

    function addRow(data={}){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input class="name wide" value="${data.name||''}"></td>
        <td><input class="protein" value="${data.protein||''}"></td>
        <td><input class="fat" value="${data.fat||''}"></td>
        <td><input class="fiber" value="${data.fiber||''}"></td>
        <td><input class="ash" value="${data.ash||''}"></td>
        <td><input class="carb" value="${data.carb||''}"></td>
        <td><input class="moisture" value="${data.moisture||''}"></td>
        <td><input class="me" value="${data.me||''}"></td>
        <td><input class="p" value="${data.p||''}" placeholder="ç£·%"></td>
        <td class="waterml"></td>
        <td><input class="pkg" value="${data.pkg||''}" placeholder="g/åŒ…"></td>
        <td class="waterpkg"></td>
        <td class="kcalg"></td>
        <td class="kcalpkg"></td>
        <td class="proteinDM col-aafco"></td>
        <td class="fatDM col-aafco"></td>
        <td class="p1000"></td>
        <td class="f1000"></td>
        <td class="pmg100"></td>
        <td class="lowp"></td>
        <td class="aafco col-aafco"></td>
        <td class="lit col-lit"></td>
        <td class="both col-both"></td>
        <td><input class="qty" value="${data.qty||0}" step="0.1"></td>
        <td class="kcalday"></td>
        <td class="reason"></td>`;
      document.querySelector('#dataTable tbody').appendChild(tr);
      tr.querySelectorAll('input').forEach(inp=> inp.addEventListener('input',()=>calc(tr)) );
      calc(tr);
    }

    // ä¸ƒæ¬¾ NumNum + Lady
    function examplesA(){
      return [
        { name:"é¦™ç‡‰å«©é›", protein:11.8, fat:5.7, fiber:0.4, ash:1.5, carb:0.7, moisture:80.3, me:1013, p:0.18, pkg:40, qty:0 },
        { name:"ç™½å¸¶é­šé›", protein:10.8, fat:4.9, fiber:0.4, ash:1.3, carb:0.2, moisture:82.8, me:879, p:0.21, pkg:40, qty:0 },
        { name:"æ°´é‡è™±ç›®é­š", protein:11.2, fat:5.5, fiber:0.4, ash:1.3, carb:0.7, moisture:81.3, me:969, p:0.20, pkg:40, qty:0},
        { name:"æ¥µé®®çƒé­š", protein:10.5, fat:5.7, fiber:0.4, ash:1.3, carb:1.5, moisture:81.0, me:991, p:0.22, pkg:40, qty:0  },
        { name:"åŸé‡ç‰›è…¿", protein:11.7, fat:5.8, fiber:0.2, ash:1.3, carb:0.4, moisture:75.8, me:937, p:0.23, pkg:81, qty:0 },
        { name:"é¦™å«©é´¨èƒ¸", protein:11.8, fat:6.4, fiber:0.2, ash:1.2, carb:0.2, moisture:76.6, me:925, p:0.19, pkg:81, qty:0 }
      ];
    }
    // ä¸ƒæ¬¾ ç£·è¦ç³»åˆ— + EnergyUp
    function examplesB(){
      return [
        { name:"ç£·è¦å¤§è‚‰åŒ… é›Ã—è”“è¶Šè“ï¼ˆæ³¥ï¼‰", protein:10.7, fat:4.8, fiber:'', ash:1.3, carb:1.1, moisture:82.1, me:904, p:'0.2073', pkg:'45', qty:0 },
        { name:"ç£·è¦å¤§è‚‰åŒ… é›Ã—ç‰›ç£ºé…¸ï¼ˆæ³¥ï¼‰", protein:10.2, fat:4.9, fiber:'', ash:1.3, carb:1.4, moisture:82.2, me:905, p:'0.201', pkg:'45', qty:0 },
        { name:"ç£·è¦å¤§è‚‰åŒ… é›Ã—UC2ï¼ˆæ³¥ï¼‰", protein:10.2, fat:4.7, fiber:'', ash:1.3, carb:1.3, moisture:82.5, me:883, p:'', pkg:'45', qty:0 },
        { name:"ç£·è¦å¤§è‚‰åŒ… é¯–é­šÃ—ç›Šç”Ÿå…ƒï¼ˆæ³¥ï¼‰", protein:11.0, fat:3.3, fiber:'', ash:1.3, carb:0.9, moisture:83.5, me:773, p:'', pkg:'45', qty:0 },
        { name:"ç£·è¦å¤§è‚‰åŒ… é¯–é­šÃ—è—œéº¥ï¼ˆçµ²ï¼‰", protein:14.6, fat:2.4, fiber:'', ash:1.3, carb:0.0, moisture:81.7, me:800, p:'', pkg:'45', qty:0 },
        { name:"ç£·è¦ç¾æ¯›åŒ… é›Ã—è† åŸè›‹ç™½ï¼ˆæ³¥ï¼‰", protein:8.7, fat:8.7, fiber:'', ash:1.2, carb:1.4, moisture:79.7, me:1193, p:0.089, pkg:'45', qty:0 },
        { name:"EnergyUp å»ä»”é­šÃ—é¯–é­š", protein:12.5, fat:6.9, fiber:0.2, ash:0.7, carb:'', moisture:79.0, me:1140, p:0.35, pkg:'45', qty:0 }
      ];
    }
    function loadExamplesAll(){
      const data = [...examplesA(), ...examplesB()];
      document.querySelector('#dataTable tbody').innerHTML='';
      data.forEach(addRow);
    }

    function getTableData(){
      const rows = [];
      document.querySelectorAll('#dataTable tbody tr').forEach(tr=>{
        const pick = cls => { const el = tr.querySelector('input.'+cls); return el? el.value : ''; };
        rows.push({
          name: pick('name'),
          protein: pick('protein'), fat: pick('fat'), fiber: pick('fiber'),
          ash: pick('ash'), carb: pick('carb'), moisture: pick('moisture'),
          me: pick('me'), p: pick('p'), pkg: pick('pkg'), qty: pick('qty')
        });
      });
      return rows;
    }
    function saveTable(){
      const data = getTableData();
      localStorage.setItem(LS_KEY, JSON.stringify(data));
      alert('å·²å„²å­˜ç›®å‰è¡¨æ ¼è³‡æ–™ï¼ˆåƒ…å„²å­˜è¼¸å…¥æ¬„ä½ï¼‰ã€‚');
    }
    function loadTable(){
      const raw = localStorage.getItem(LS_KEY);
      if(!raw){ alert('å°šç„¡å„²å­˜è³‡æ–™'); return; }
      let data=[]; try{ data = JSON.parse(raw); }catch(e){ alert('è®€å–å¤±æ•—'); return; }
      document.querySelector('#dataTable tbody').innerHTML='';
      data.forEach(obj=> addRow(obj));
      updateDailySummary();
      alert('å·²è¼‰å…¥å„²å­˜è³‡æ–™ã€‚');
    }
    function clearSaved(){
      localStorage.removeItem(LS_KEY);
      alert('å·²æ¸…é™¤å„²å­˜è³‡æ–™ã€‚');
    }
    function resetQty(){
      document.querySelectorAll('#dataTable tbody tr input.qty').forEach(inp=>{ inp.value = 0; });
      document.querySelectorAll('#dataTable tbody tr').forEach(tr=> calc(tr));
      updateDailySummary();
    }

    function downloadCSV(){
      const headers = Array.from(document.querySelectorAll('#dataTable thead th')).map(th=> th.textContent.replace(/\n/g,' '));
      const rows = Array.from(document.querySelectorAll('#dataTable tbody tr')).map(tr=>
        Array.from(tr.children).map(td=> td.querySelector('input')? td.querySelector('input').value : td.textContent)
      );
      const all = [headers, ...rows];
      const csv = all.map(r=> r.map(x=> '"'+(x??'').replace(/"/g,'""')+'"').join(',')).join('\n');
      const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'AAFCO_DM_all14.csv'; a.click(); URL.revokeObjectURL(a.href);
    }

    function clearTable(){ document.querySelector('#dataTable tbody').innerHTML=''; updateDailySummary(); }

    // OCR èˆ‡è²¼ä¸Š
    document.getElementById('ocrToRow').addEventListener('click', async ()=>{
      const file = document.getElementById('imgInput').files[0];
      const status = document.getElementById('ocrStatus');
      if(!file) return alert('è«‹å…ˆé¸æ“‡åœ–ç‰‡æª”');
      status.textContent = 'è¾¨è­˜ä¸­...';
      if(!window.Tesseract){ const s=document.createElement('script'); s.src='https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js'; document.body.appendChild(s); await new Promise(r=>setTimeout(r,1500)); }
      const result = await Tesseract.recognize(file,'eng+chi_tra');
      const text = result.data.text||''; status.textContent='å®Œæˆ';
      const pick = (re) => { const m=text.match(re); return m? parseFloat(m[1]) : '' };
      addRow({
        name:file.name.replace(/\.[^.]+$/, ''),
        protein: pick(/(è›‹ç™½|Protein)[^\d%]{0,10}([\d\.]+)\s*%/i),
        fat:     pick(/(è„‚è‚ª|Fat)[^\d%]{0,10}([\d\.]+)\s*%/i),
        fiber:   pick(/(çº–ç¶­|Fiber)[^\d%]{0,10}([\d\.]+)\s*%/i),
        ash:     pick(/(ç°åˆ†|Ash)[^\d%]{0,10}([\d\.]+)\s*%/i),
        moisture:pick(/(æ°´åˆ†|Moisture)[^\d%]{0,10}([\d\.]+)\s*%/i),
        carb:    pick(/(ç¢³æ°´|Carb)[^\d%]{0,10}([\d\.]+)\s*%/i),
        me:      ( ()=>{ const k100=pick(/([\d\.]+)\s*kcal\s*\/\s*100\s*g/i); if(k100) return k100*10; const kkg=pick(/([\d\.]+)\s*kcal\s*\/\s*kg/i); return kkg||''; } )(),
        p:       pick(/(ç£·|Phosphorus)[^\d%]{0,10}([\d\.]+)\s*%/i)
      });
    });

    document.getElementById('pasteText').addEventListener('click', ()=>{
      const t = prompt('è«‹è²¼ä¸Š OCR æˆ–ç‡Ÿé¤Šæ–‡å­—ï¼ˆæœƒå˜—è©¦è§£æ % èˆ‡ kcalï¼‰');
      if(!t) return;
      const pick = (re) => { const m=t.match(re); return m? parseFloat(m[1]) : '' };
      addRow({
        name:'è²¼ä¸Šæ–‡å­—',
        protein: pick(/(è›‹ç™½|Protein)[^\d%]{0,10}([\d\.]+)\s*%/i),
        fat:     pick(/(è„‚è‚ª|Fat)[^\d%]{0,10}([\d\.]+)\s*%/i),
        fiber:   pick(/(çº–ç¶­|Fiber)[^\d%]{0,10}([\d\.]+)\s*%/i),
        ash:     pick(/(ç°åˆ†|Ash)[^\d%]{0,10}([\d\.]+)\s*%/i),
        moisture:pick(/(æ°´åˆ†|Moisture)[^\d%]{0,10}([\d\.]+)\s*%/i),
        carb:    pick(/(ç¢³æ°´|Carb)[^\d%]{0,10}([\d\.]+)\s*%/i),
        me:      ( ()=>{ const k100=pick(/([\d\.]+)\s*kcal\s*\/\s*100\s*g/i); if(k100) return k100*10; const kkg=pick(/([\d\.]+)\s*kcal\s*\/\s*kg/i); return kkg||''; } )(),
        p:       pick(/(ç£·|Phosphorus)[^\d%]{0,10}([\d\.]+)\s*%/i)
      });
    });

    // é è¨­
    (function init(){ addRow(); applyMode(); updateDailySummary(); })();
  </script>
</body>
</html>
